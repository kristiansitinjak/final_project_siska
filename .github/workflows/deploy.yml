name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Tentukan environment untuk mengakses secrets
    environment: AWS_ACCESS_KEY
    steps:
      # Langkah 1: Checkout kode dari repositori
      - name: Checkout code
        uses: actions/checkout@v3

      # Langkah 2: Konfigurasi kredensial AWS
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        environment: AWS_ACCESS_KEY
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_ACCESS_SECRET_KEY }}
          aws-region: us-east-1  # Sesuaikan dengan region EC2 kamu

      # Langkah 3: Deploy ke EC2 menggunakan SSH dengan error handling
      - name: Deploy to EC2
        environment:
          name: EC_HOST
          name: EC_KEY
        run: |
          ssh -o StrictHostKeyChecking=no -i ${{ secrets.EC2_KEY }} ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
            # Pastikan direktori ada
            cd final_project_siska || { echo "Directory not found"; exit 1; }
            # Pull kode terbaru
            git pull origin main || { echo "Failed to pull from GitHub"; exit 1; }
            # Install dependensi
            npm install || { echo "Failed to install npm dependencies"; exit 1; }
            # Restart aplikasi dengan fallback
            pm2 restart index.js || pm2 start index.js --name "node-app" || { echo "PM2 restart/start failed"; exit 1; }
            echo "Deployment completed successfully at $(date)"
          EOF
